name: microk8s
version-script: |
  . build-scripts/set-env-variables.sh > /dev/null
  echo $KUBE_VERSION
version: "latest"
summary: Kubernetes for workstations and appliances
description: |-
 MicroK8s is a small, fast, secure, single node Kubernetes that installs on
 just about any Linux box. Use it for offline development, prototyping,
 testing, or use it on a VM as a small, cheap, reliable k8s for CI/CD. It's
 also a great k8s for appliances - develop your IoT apps for k8s and deploy
 them to MicroK8s on your boxes.

grade: stable
confinement: strict
base: core18

plugs:
  docker-privileged:
    interface: docker-support
    privileged-containers: true
  k8s-kubelet:
    interface: kubernetes-support
    flavor: kubelet
  k8s-kubeproxy:
    interface: kubernetes-support
    flavor: kubeproxy
  k8s-journald:
    interface: kubernetes-support
    flavor: autobind-unix
  dot-kube:
    interface: personal-files
    write:
    - $HOME/.kube
  ld-cache:
    interface: system-files
    read:
    - /etc/ld.so.cache

hooks:
  configure:
    plugs:
    - dot-kube
  install:
    plugs:
    - network-bind
    - network-control
    - firewall-control
  remove:
    plugs:
    - k8s-kubelet
    - mount-observe
    - network-bind
    - network-control
    - firewall-control

apps:
  microk8s:
    command: microk8s.wrapper
  daemon-etcd:
    command: run-etcd-with-args
    daemon: simple
    plugs:
    - network-bind
  daemon-flanneld:
    command: run-flanneld-with-args
    daemon: simple
    plugs:
    - network-bind
    - network-control
    - firewall-control
  daemon-containerd:
    command: run-containerd-with-args
    daemon: simple
    plugs:
    - ld-cache
    - k8s-journald
    - network-bind
    - docker-support
    - docker-privileged
    - firewall-control
    - kernel-module-control
    - network-control
    - mount-observe
    - kubernetes-support
    - opengl
    - cifs-mount
    - fuse-support
  daemon-apiserver:
    command: run-with-config-args kube-apiserver
    daemon: simple
    plugs:
    - network-bind
    - network-observe
    - k8s-journald
  daemon-apiserver-kicker:
    command: apiservice-kicker
    daemon: simple
    plugs:
    - account-control
    - network-bind
    - network-observe
    - network-control
  daemon-cluster-agent:
    command: run-cluster-agent-with-args
    daemon: simple
    plugs:
    - mount-observe
    - network-bind
    - network-observe
    - network-control
  daemon-controller-manager:
    command: run-with-config-args kube-controller-manager
    daemon: simple
    plugs:
    - network-bind
    - docker-support
    - docker-privileged
    - firewall-control
    - kernel-module-control
    - network-control
  daemon-scheduler:
    command: run-with-config-args kube-scheduler
    daemon: simple
    plugs:
    - network-bind
    - k8s-journald
  daemon-kubelet:
    command: run-with-config-args kubelet
    daemon: simple
    plugs:
    - dot-kube
    - firewall-control
    - hardware-observe
    - k8s-kubelet
    - k8s-journald
    - mount-observe
    - network-bind
    - network-control
    - process-control
    - system-observe
    - opengl
  daemon-proxy:
    command: run-with-config-args kube-proxy
    daemon: simple
    plugs:
    - network-bind
    - network-control
    - network-observe
    - firewall-control
    - k8s-kubeproxy
    - kernel-module-observe
    - mount-observe
    - system-observe
    - kernel-module-control
  dashboard-proxy:
    command: microk8s-dashboard-proxy.wrapper
    plugs:
    - network-bind
    - network-control
    - network-observe
    - firewall-control
    - k8s-kubeproxy
    - kernel-module-observe
    - mount-observe
    - system-observe
    - kernel-module-control
  kubectl:
    command: microk8s-kubectl.wrapper
    completer: kubectl.bash
    plugs:
    - dot-kube
    - home
    - firewall-control
    - network-bind
    - k8s-kubelet
    - hardware-observe
    - mount-observe
    - network-control
    - process-control
    - system-observe
  add-node:
    command: microk8s-add-node.wrapper
    plugs:
    - network
    - network-bind
    - network-observe
    - mount-observe
  refresh-certs:
    command: microk8s-refresh-certs.wrapper
  join:
    command: microk8s-join.wrapper
    plugs:
    - network
    - mount-observe
  remove-node:
    command: microk8s-remove-node.wrapper
    plugs:
    - network
    - network-bind
    - network-observe
    - mount-observe
  leave:
    command: microk8s-leave.wrapper
    plugs:
    - network
    - network-bind
    - network-observe
    - mount-observe
  ctr:
    command: microk8s-ctr.wrapper
    plugs:
    - dot-kube
    - home
    - firewall-control
    - network-bind
    - k8s-kubelet
    - hardware-observe
    - mount-observe
    - network-control
    - process-control
    - system-observe
  inspect:
    command: sudo SNAP_DATA=${SNAP_DATA} ${SNAP}/inspect.sh
  enable:
    command: microk8s-enable.wrapper
    plugs:
    - home
    - network
    - network-control
    - kernel-module-observe
    - opengl
  disable:
    command: microk8s-disable.wrapper
    plugs:
    - network
    - network-control
  start:
    command: microk8s-start.wrapper
    plugs:
    - network
  stop:
    command: microk8s-stop.wrapper
    plugs:
    - network
  status:
    command: microk8s-status.wrapper
    plugs:
    - network
  config:
    command: microk8s-config.wrapper
  reset:
    command: microk8s-reset.wrapper
    plugs:
    - network
  istioctl:
    command: microk8s-istioctl.wrapper
    plugs:
    - network
  linkerd:
    command: microk8s-linkerd.wrapper
    plugs:
    - network
  helm:
    command: microk8s-helm.wrapper
    plugs:
    - network
  helm3:
    command: microk8s-helm3.wrapper
    plugs:
    - network
  cilium:
    command: microk8s-cilium.wrapper
    plugs:
    - network
  juju:
    command: microk8s-juju.wrapper
    plugs:
    - network

passthrough:
  system-usernames:
    snap_daemon: shared
  layout:
    /usr/libexec:
      symlink: $SNAP_COMMON/usr/libexec
    /usr/local/lib:
      bind: $SNAP_COMMON/usr/local/lib
    /var/lib/cni:
      bind: $SNAP_COMMON/var/lib/cni
    /var/log/pods:
      bind: $SNAP_COMMON/var/log/pods
    /var/log/containers:
      bind: $SNAP_COMMON/var/log/containers
    /var/lib/kubelet:
      bind: $SNAP_DATA/kubelet
    /var/lib/kube-proxy:
      bind: $SNAP_DATA/kube-proxy
    /etc/nvidia-container-runtime/config.toml:
      bind-file: $SNAP_COMMON/etc/nvidia-container-runtime/config.toml
    /var/log/nvidia-container-runtime.log:
      bind-file: $SNAP_COMMON/var/log/nvidia-container-runtime.log
    /usr/lib/x86_64-linux-gnu/libnvoptix.so.1:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvoptix.so.1
    /usr/lib/x86_64-linux-gnu/libnvoptix.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvoptix.so.435.21
    /usr/lib/x86_64-linux-gnu/libnvidia-opticalflow.so:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-opticalflow.so
    /usr/lib/x86_64-linux-gnu/libnvidia-opticalflow.so.1:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-opticalflow.so.1
    /usr/lib/x86_64-linux-gnu/libnvidia-opticalflow.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-opticalflow.so.435.21
    /usr/lib/x86_64-linux-gnu/libnvidia-tls.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-tls.so.435.21
    /usr/lib/x86_64-linux-gnu/libnvcuvid.so:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvcuvid.so
    /usr/lib/x86_64-linux-gnu/libnvcuvid.so.1:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvcuvid.so.1
    /usr/lib/x86_64-linux-gnu/libnvcuvid.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvcuvid.so.435.21
    /usr/lib/x86_64-linux-gnu/libnvidia-cfg.so:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-cfg.so
    /usr/lib/x86_64-linux-gnu/libnvidia-rtcore.so.1:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-rtcore.so.1
    /usr/lib/x86_64-linux-gnu/libnvidia-rtcore.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-rtcore.so.435.21
    /usr/lib/x86_64-linux-gnu/libnvidia-cfg.so.1:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-cfg.so.1
    /usr/lib/x86_64-linux-gnu/libnvidia-cfg.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-cfg.so.435.21
    /usr/lib/x86_64-linux-gnu/libnvidia-compiler.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-compiler.so.435.21
    /usr/lib/x86_64-linux-gnu/libnvidia-eglcore.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-eglcore.so.435.21
    /usr/lib/x86_64-linux-gnu/libnvidia-encode.so:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-encode.so
    /usr/lib/x86_64-linux-gnu/libnvidia-encode.so.1:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-encode.so.1
    /usr/lib/x86_64-linux-gnu/libnvidia-encode.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-encode.so.435.21
    /usr/lib/x86_64-linux-gnu/libnvidia-fatbinaryloader.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-fatbinaryloader.so.435.21
    /usr/lib/x86_64-linux-gnu/libnvidia-fbc.so:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-fbc.so
    /usr/lib/x86_64-linux-gnu/libnvidia-fbc.so.1:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-fbc.so.1
    /usr/lib/x86_64-linux-gnu/libnvidia-fbc.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-fbc.so.435.21
    /usr/lib/x86_64-linux-gnu/libnvidia-glcore.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-glcore.so.435.21
    /usr/lib/x86_64-linux-gnu/libnvidia-glsi.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-glsi.so.435.21
    /usr/lib/x86_64-linux-gnu/libnvidia-glvkspirv.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-glvkspirv.so.435.21
    /usr/lib/x86_64-linux-gnu/libnvidia-ifr.so:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-ifr.so
    /usr/lib/x86_64-linux-gnu/libnvidia-ifr.so.1:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-ifr.so.1
    /usr/lib/x86_64-linux-gnu/libnvidia-ifr.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-ifr.so.435.21
    /usr/lib/x86_64-linux-gnu/libnvidia-ml.so:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-ml.so
    /usr/lib/x86_64-linux-gnu/libnvidia-ml.so.1:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-ml.so.1
    /usr/lib/x86_64-linux-gnu/libnvidia-ml.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-ml.so.435.21
    /usr/lib/x86_64-linux-gnu/libnvidia-opencl.so.1:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-opencl.so.1
    /usr/lib/x86_64-linux-gnu/libnvidia-opencl.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-opencl.so.435.21
    /usr/lib/x86_64-linux-gnu/libnvidia-ptxjitcompiler.so:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-ptxjitcompiler.so
    /usr/lib/x86_64-linux-gnu/libnvidia-ptxjitcompiler.so.1:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-ptxjitcompiler.so.1
    /usr/lib/x86_64-linux-gnu/libnvidia-ptxjitcompiler.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libnvidia-ptxjitcompiler.so.435.21
    /usr/lib/x86_64-linux-gnu/libcuda.so:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libcuda.so
    /usr/lib/x86_64-linux-gnu/libcuda.so.1:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libcuda.so.1
    /usr/lib/x86_64-linux-gnu/libcuda.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libcuda.so.435.21
    /usr/lib/x86_64-linux-gnu/libEGL_nvidia.so.0:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libEGL_nvidia.so.0
    /usr/lib/x86_64-linux-gnu/libEGL_nvidia.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libEGL_nvidia.so.435.21
    /usr/lib/x86_64-linux-gnu/libGLX_nvidia.so.0:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libGLX_nvidia.so.0
    /usr/lib/x86_64-linux-gnu/libGLX_nvidia.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libGLX_nvidia.so.435.21
    /usr/lib/x86_64-linux-gnu/libGLESv1_CM_nvidia.so.1:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libGLESv1_CM_nvidia.so.1
    /usr/lib/x86_64-linux-gnu/libGLESv1_CM_nvidia.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libGLESv1_CM_nvidia.so.435.21
    /usr/lib/x86_64-linux-gnu/libGLESv2_nvidia.so.2:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libGLESv2_nvidia.so.2
    /usr/lib/x86_64-linux-gnu/libGLESv2_nvidia.so.435.21:
      bind-file: $SNAP/var/lib/snapd/lib/gl/libGLESv2_nvidia.so.435.21

parts:
  patches:
    plugin: dump
    source: patches/
    prime: ["-*"]
  libnftnl:
    plugin: autotools
    source: https://www.netfilter.org/projects/libnftnl/files/libnftnl-1.0.9.tar.bz2
    build-packages:
    - libjansson-dev
    - libmnl-dev
  iptables:
    after:
    - libnftnl
    source: https://www.netfilter.org/projects/iptables/files/iptables-1.6.1.tar.bz2
    plugin: autotools
    build-packages:
    - bison
    - flex
    - libmnl-dev
    - libnfnetlink-dev
    - libnetfilter-conntrack3
    - libnetfilter-conntrack-dev
    configflags:
    - "--disable-shared"
    - "--enable-static"
    prime: [ -bin/iptables-xml ]
  libco:
    source: https://github.com/canonical/libco
    build-attributes: [no-patchelf]
    source-type: git
    plugin: make
    organize:
      usr/lib/: lib/
    prime:
      - lib/libco*so*
  raft:
    source: https://github.com/canonical/raft
    build-attributes: [no-patchelf]
    source-type: git
    plugin: autotools
    stage-packages:
      - libuv1
    organize:
      usr/lib/: lib/
      include/: usr/include/
    prime:
      - lib/libraft*so*
      - usr/include/
  sqlite:
    source: https://github.com/canonical/sqlite
    source-type: git
    build-attributes: [no-patchelf]
    plugin: autotools
    configflags:
      - --enable-replication
    build-packages:
      - tclsh
    override-build: |-
      set -ex

      git log -1 --format=format:%ci%n | sed -e 's/ [-+].*$//;s/ /T/;s/^/D /' > manifest
      git log -1 --format=format:%H > manifest.uuid
      cp /usr/share/misc/config.guess .
      cp /usr/share/misc/config.sub .
      autoreconf -f -i

      set +ex
      snapcraftctl build
    organize:
      include/: usr/include/
    prime:
      - bin/sqlite3
      - lib/libsqlite3*so*
      - usr/include/
  dqlite:
    after:
      - libco
      - raft
      - sqlite
    source: https://github.com/canonical/dqlite
    build-attributes: [no-patchelf]
    source-type: git
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
      include/: usr/include/
    prime:
      - lib/libdqlite*so*
      - lib/*/libuv*
      - usr/include/
  libnftnl:
    plugin: autotools
    source: https://www.netfilter.org/projects/libnftnl/files/libnftnl-1.0.9.tar.bz2
    build-packages:
    - libjansson-dev
    - libmnl-dev
  iptables:
    after:
    - libnftnl
    source: https://www.netfilter.org/projects/iptables/files/iptables-1.6.1.tar.bz2
    plugin: autotools
    build-packages:
    - bison
    - flex
    - libmnl-dev
    - libnfnetlink-dev
    - libnetfilter-conntrack3
    - libnetfilter-conntrack-dev
    configflags:
    - "--disable-shared"
    - "--enable-static"
    prime: [ -bin/iptables-xml ]
  migrator:
    build-snaps: [go]
    source: https://github.com/ktsakalozos/go-migrator
    source-type: git
    plugin: go
    go-importpath: github.com/ktsakalozos/go-migrator
    build-packages:
      - gcc
    prime:
      - bin/migrator
  containerd:
    build-snaps: [go]
    after: [iptables, patches]
    source: https://github.com/containerd/containerd
    source-type: git
    plugin: go
    go-importpath: github.com/containerd/containerd
    build-packages:
    - btrfs-tools
    - libseccomp-dev
    override-build: |
      set -eux
      . $SNAPCRAFT_PROJECT_DIR/build-scripts/set-env-variables.sh

      go version
      export GOPATH=$(realpath ../go)
      mkdir -p $SNAPCRAFT_PART_INSTALL/bin

      # Build runc
      go get github.com/opencontainers/runc
      (
        cd $GOPATH/src/github.com/opencontainers/runc
        git checkout ${RUNC_COMMIT}

        for patch in "$SNAPCRAFT_STAGE"/runc-patches/*.patch; do
          echo "Applying $(basename "$patch") ..."
          git apply --ignore-space-change --ignore-whitespace "$patch"
          echo
        done

        make BUILDTAGS='seccomp apparmor'
      )
      cp $GOPATH/src/github.com/opencontainers/runc/runc $SNAPCRAFT_PART_INSTALL/bin/

      # Build containerd
      go get -d github.com/containerd/containerd
      (
        cd $GOPATH/src/github.com/containerd/containerd
        git checkout ${CONTAINERD_COMMIT}
        # building the btrfs driver can be disabled via the
        # build tag no_btrfs, removing this dependency
        make
      )
      cp $GOPATH/src/github.com/containerd/containerd/bin/* $SNAPCRAFT_PART_INSTALL/bin/
      rm $SNAPCRAFT_PART_INSTALL/bin/containerd-stress

    organize:
      containerd/install/bin/*: bin/
    stage-packages:
    - libnss-myhostname
    - libnss-resolve
    - libnss-mymachines
    - conntrack
    - curl
    - aufs-tools
    - gawk
    - sed
    - socat
    - grep
    - jq
    - libssl1.0.0
    - coreutils
    - hostname
    - diffutils
    - squashfs-tools
    - tar
    stage:
    - -sbin/xtables-multi
    - -sbin/iptables*
    - -lib/xtables
  cluster-agent:
    plugin: python
    python-version: python3
    source: .
    python-packages:
    - flask
    - PyYAML
    - netifaces
    stage-packages:
    - python3-openssl
    - openssl
    - python3-requests
    - gunicorn3
  microk8s:
    after: [containerd, dqlite]
    plugin: dump
    build-attributes: [no-patchelf]
    build-packages:
    - make
    - mercurial
    - git
    - rsync
    - openssl
    - file
    - dpkg
    stage-packages:
    - libatm1
    - net-tools
    - util-linux
    - zfsutils-linux
    - iproute2
    source: .
    prime:
      - -README*
      - -installer*
      - -tests*
      - -docs*
      - -build*
      - -go*
    override-build: |
      set -eux
      . build-scripts/set-env-variables.sh

      REMOVE_KUBE_SNAP_BINS=false
      echo "Reached here"
      # if "${KUBE_SNAP_BINS}" exist we have to use the binaries from there
      # if "${KUBE_SNAP_BINS}" does not exist but it is set we will put the k8s binaries there
      # if "${KUBE_SNAP_BINS}" does not exist and it is not set we do not need to keep the created binaries
      if [ ! -e "${KUBE_SNAP_BINS}" ]; then
        if [ -z "${KUBE_SNAP_BINS}" ]; then
          # "${KUBE_SNAP_BINS}" not set, we will remove the binaries after we build them.
          REMOVE_KUBE_SNAP_BINS=true
          . build-scripts/set-env-binaries-location.sh
        fi
        echo "Downloading binaries"
        . build-scripts/fetch-other-binaries.sh
        echo "Building k8s binaries"
        . build-scripts/build-k8s-binaries.sh
      else
        echo "Binaries provided in $KUBE_SNAP_BINS"
      fi

      echo "Setting default daemon configs"
      cp -r $KUBE_SNAP_ROOT/microk8s-resources/default-args .

      echo "Building certs"
      cp -r $KUBE_SNAP_ROOT/microk8s-resources/certs .
      cp -r $KUBE_SNAP_ROOT/microk8s-resources/certs-beta .

      echo "Preparing cni"
      mkdir -p opt/cni/bin/
      cp $KUBE_SNAP_BINS/cni/* opt/cni/bin/

      echo "Preparing flanneld"
      mkdir -p opt/cni/bin/
      cp $KUBE_SNAP_BINS/flanneld/flanneld opt/cni/bin/

      echo "Preparing containerd"
      cp $KUBE_SNAP_ROOT/microk8s-resources/containerd-profile .

      echo "Preparing etcd"
      cp $KUBE_SNAP_BINS/etcd/etcd .
      cp $KUBE_SNAP_BINS/etcd/etcdctl .

      echo "Preparing kube-apiserver"
      cp $KUBE_SNAP_BINS/$KUBE_ARCH/kube-apiserver .
      # Old versions will be pointing to these .csv files from inside their kube-apiserver config
      # Keep them around for a couple of releases.
      touch known_token.csv
      cp $KUBE_SNAP_ROOT/microk8s-resources/basic_auth.csv .

      echo "Preparing kube-controller-manager"
      cp $KUBE_SNAP_BINS/$KUBE_ARCH/kube-controller-manager .

      echo "Preparing kube-scheduler"
      cp $KUBE_SNAP_BINS/$KUBE_ARCH/kube-scheduler .

      echo "Preparing kubelet"
      mkdir -p configs
      cp $KUBE_SNAP_BINS/$KUBE_ARCH/kubelet .

      echo "Preparing kube-proxy"
      cp $KUBE_SNAP_BINS/$KUBE_ARCH/kube-proxy .

      echo "Preparing kubelet"
      cp $KUBE_SNAP_BINS/$KUBE_ARCH/kubectl .

      echo "Preparing user config"
      cp $KUBE_SNAP_ROOT/microk8s-resources/client.config.template .

      echo "Creating commands and wrappers"
      cp $KUBE_SNAP_ROOT/microk8s-resources/wrappers/* .

      cp -r $KUBE_SNAP_ROOT/microk8s-resources/actions .
      if [ "${ARCH}" = "arm64" ]
      then
        # Some actions are not available on arm64
        # Nvidia support
        rm "actions/enable.gpu.sh"
        rm "actions/disable.gpu.sh"
        rm "actions/gpu.yaml"
        # Istio support
        rm "actions/enable.istio.sh"
        rm "actions/disable.istio.sh"
        # Knative support
        rm "actions/enable.knative.sh"
        rm "actions/disable.knative.sh"
        # Prometheus support
        rm "actions/enable.prometheus.sh"
        rm "actions/disable.prometheus.sh"
        rm -rf "actions/prometheus"
        # Fluentd support
        rm "actions/enable.fluentd.sh"
        rm "actions/disable.fluentd.sh"
        rm -rf "actions/fluentd"
        # Jeager support
        rm "actions/enable.jaeger.sh"
        rm "actions/disable.jaeger.sh"
        rm -rf "actions/jaeger"
        # Linkerd support
        rm "actions/enable.linkerd.sh"
        rm "actions/disable.linkerd.sh"
        # Juju support
        rm "actions/enable.juju.sh"
        rm "actions/disable.juju.sh"
        # Kubeflow support
        rm "actions/enable.kubeflow.sh"
        rm "actions/disable.kubeflow.sh"
      else
        # Knative support
        echo "Preparing knative"
        cp -r $KUBE_SNAP_BINS/knative-yaml ./actions/knative
      fi

      echo "Creating inspect hook"
      cp $KUBE_SNAP_ROOT/scripts/inspect.sh .

      # Add bash completion for microk8s kubectl.
      ./kubectl completion bash | sed "s/complete -o default -F __start_kubectl kubectl/complete -o default -F __start_kubectl microk8s kubectl/g" | sed "s/complete -o default -o nospace -F __start_kubectl kubectl/complete -o default -o nospace -F __start_kubectl kubectl/g" > kubectl.bash
      ./kubectl completion bash | sed "s/complete -o default -F __start_kubectl kubectl/complete -o default -F __start_kubectl microk8s.kubectl/g" | sed "s/complete -o default -o nospace -F __start_kubectl kubectl/complete -o default -o nospace -F __start_kubectl kubectl/g" > kubectl.bash

      if $REMOVE_KUBE_SNAP_BINS; then
        rm -rf "$KUBE_SNAP_BINS"
      fi
      snapcraftctl build

  nvidia-runtime:
    plugin: nil
    build-packages:
      - gcc
      - make
      - pkg-config
    build-snaps:
      - go
    source: https://github.com/NVIDIA/nvidia-container-runtime
    source-type: git
    source-tag: "3.1.0"
    override-build: |
      set -eu
      mkdir go
      export GOPATH="$(pwd)/go"
      export PATH="${GOPATH}/bin:${PATH}"
      cd runtime/src/
      go get -u github.com/pelletier/go-toml
      go get -u github.com/opencontainers/runtime-spec/specs-go
      make
      mkdir -p $SNAPCRAFT_PART_INSTALL/usr/bin/
      cp nvidia-container-runtime $SNAPCRAFT_PART_INSTALL/usr/bin/nvidia-container-runtime
      # cd ../../hook/nvidia-container-runtime-hook
      # go get -u github.com/BurntSushi/toml
      # go build
      # cp nvidia-container-runtime-hook $SNAPCRAFT_PART_INSTALL/usr/bin/nvidia-container-runtime-hook

  nvidia-runtime-toolkit:
    plugin: nil
    build-packages:
      - curl
      - gcc
      - make
      - pkg-config
    build-snaps:
      - go
    source: https://github.com/NVIDIA/container-toolkit
    source-type: git
    override-build: |
      set -eu
      mkdir go
      export GOPATH="$(pwd)/go"
      export PATH="${GOPATH}/bin:${PATH}"
      go get -u github.com/BurntSushi/toml
      cd pkg
      go build -ldflags "-s -w" -o nvidia-container-toolkit
      mkdir -p $SNAPCRAFT_PART_INSTALL/usr/bin/
      cp nvidia-container-toolkit $SNAPCRAFT_PART_INSTALL/usr/bin/nvidia-container-toolkit
      cp nvidia-container-toolkit $SNAPCRAFT_PART_INSTALL/usr/bin/nvidia-container-runtime-hook

  libnvidia:
    after: [patches]
    plugin: nil
    build-packages:
      - gcc
      - make
      - bmake
      - m4
      - pkg-config
      - lsb-core
      - libcap-dev
      - libseccomp-dev
    source: https://github.com/NVIDIA/libnvidia-container
    source-type: git
    source-tag: v1.0.6
    override-build: |
      for patch in "$SNAPCRAFT_STAGE"/libnvidia-patches/*.patch; do
        echo "Applying $(basename "$patch") ..."
        git apply --ignore-space-change --ignore-whitespace "$patch"
        echo
      done
      make
      make install

  juju:
    plugin: dump
    source: https://launchpad.net/juju/2.7/2.7.6/+download/juju-2.7.6-k8s.tar.xz
    source-type: tar
    organize:
      juju: bin/juju
    prime:
      - bin/juju

slots:
  microk8s:
    interface: content
    content: microk8s
    source:
      read: [$SNAP/.microk8s-info/microk8s]
